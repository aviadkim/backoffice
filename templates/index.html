<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת סריקת מסמכים</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .table-responsive {
            margin-bottom: 1rem;
        }
        .img-fluid {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .nav-tabs {
            margin-bottom: 1rem;
        }
        .tab-content {
            background-color: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">מערכת סריקת מסמכים</h1>
        
        <!-- Upload Form -->
        <div class="card">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">בחר קובץ PDF:</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary">העלה וסרוק</button>
                </form>
            </div>
        </div>
        
        <!-- Loading Section -->
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">טוען...</span>
            </div>
            <p class="mt-2">מעבד את המסמך...</p>
        </div>
        
        <!-- Results Section -->
        <div id="results" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">מידע על המסמך</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>שם הקובץ:</strong> <span id="filename"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>מספר עמודים:</strong> <span id="pages"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>גודל הקובץ:</strong> <span id="size"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>תאריך עיבוד:</strong> <span id="date"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="holdings-tab" data-bs-toggle="tab" data-bs-target="#holdings" type="button" role="tab">אחזקות</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab">טקסט</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tables-tab" data-bs-toggle="tab" data-bs-target="#tables" type="button" role="tab">טבלאות</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">תמונות</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="resultsTabContent">
                <div class="tab-pane fade show active" id="holdings" role="tabpanel">
                    <div id="holdings-content" class="p-3">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>ISIN</th>
                                        <th>שם נייר</th>
                                        <th>מחיר</th>
                                        <th>כמות</th>
                                        <th>שווי</th>
                                        <th>מטבע</th>
                                    </tr>
                                </thead>
                                <tbody id="holdings-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="text" role="tabpanel">
                    <div id="text-content" class="p-3"></div>
                </div>
                <div class="tab-pane fade" id="tables" role="tabpanel">
                    <div id="tables-container" class="p-3"></div>
                </div>
                <div class="tab-pane fade" id="images" role="tabpanel">
                    <div id="images-container" class="p-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('אנא בחר קובץ');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('אנא העלה קובץ PDF בלבד');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                } else {
                    alert(data.error || 'שגיאה בעיבוד הקובץ');
                }
            } catch (error) {
                alert('שגיאה בהעלאת הקובץ');
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
        
        // Display results
        function displayResults(data) {
            // Show results area
            document.getElementById('results').style.display = 'block';
            
            // Display metadata
            const metadata = data.metadata;
            document.getElementById('filename').textContent = metadata.filename;
            document.getElementById('pages').textContent = metadata.total_pages;
            document.getElementById('size').textContent = formatFileSize(metadata.file_size);
            document.getElementById('date').textContent = new Date(metadata.processed_date).toLocaleString();
            
            // Format numbers function
            function formatNumber(num) {
                return new Intl.NumberFormat('he-IL').format(num);
            }
            
            // Display holdings
            const holdingsTableBody = document.getElementById('holdings-table-body');
            holdingsTableBody.innerHTML = '';
            
            if (data.financial_data && data.financial_data.holdings && data.financial_data.holdings.length > 0) {
                data.financial_data.holdings.forEach(holding => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${holding.isin || ''}</td>
                        <td>${holding.name || ''}</td>
                        <td class="text-end">${holding.price ? formatNumber(holding.price) : ''}</td>
                        <td class="text-end">${holding.quantity ? formatNumber(holding.quantity) : ''}</td>
                        <td class="text-end">${holding.value ? formatNumber(holding.value) : ''}</td>
                        <td>${holding.currency || ''}</td>
                    `;
                    holdingsTableBody.appendChild(row);
                });
            } else {
                // Check for holdings in tables
                let holdingsFound = false;
                
                if (data.tables && data.tables.length > 0) {
                    data.tables.forEach(table => {
                        if (table.type === 'holdings' && table.holdings && table.holdings.length > 0) {
                            holdingsFound = true;
                            table.holdings.forEach(holding => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${holding.isin || ''}</td>
                                    <td>${holding.name || ''}</td>
                                    <td class="text-end">${holding.price ? formatNumber(holding.price) : ''}</td>
                                    <td class="text-end">${holding.quantity ? formatNumber(holding.quantity) : ''}</td>
                                    <td class="text-end">${holding.value ? formatNumber(holding.value) : ''}</td>
                                    <td>${holding.currency || ''}</td>
                                `;
                                holdingsTableBody.appendChild(row);
                            });
                        }
                    });
                }
                
                if (!holdingsFound) {
                    holdingsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">לא נמצאו אחזקות במסמך</td></tr>';
                }
            }
            
            // Display text content
            const textContent = document.getElementById('text-content');
            textContent.innerHTML = data.text ? data.text.replace(/\n/g, '<br>') : 'לא נמצא טקסט במסמך';
            
            // Display tables
            const tablesContainer = document.getElementById('tables-container');
            tablesContainer.innerHTML = '';
            
            if (data.tables && data.tables.length > 0) {
                data.tables.forEach((table, index) => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'table-responsive mb-4';
                    
                    let tableHtml = '<table class="table table-bordered">';
                    
                    // Add headers
                    if (table.headers && table.headers.length > 0) {
                        tableHtml += '<thead><tr>';
                        table.headers.forEach(header => {
                            tableHtml += `<th>${header}</th>`;
                        });
                        tableHtml += '</tr></thead>';
                    }
                    
                    // Add data rows
                    if (table.data && table.data.length > 0) {
                        tableHtml += '<tbody>';
                        table.data.forEach(row => {
                            tableHtml += '<tr>';
                            row.forEach(cell => {
                                tableHtml += `<td>${cell}</td>`;
                            });
                            tableHtml += '</tr>';
                        });
                        tableHtml += '</tbody>';
                    }
                    
                    tableHtml += '</table>';
                    tableDiv.innerHTML = tableHtml;
                    tablesContainer.appendChild(tableDiv);
                });
            } else {
                tablesContainer.innerHTML = '<p>לא נמצאו טבלאות במסמך</p>';
            }
            
            // Display images with their text
            const imagesContainer = document.getElementById('images-container');
            imagesContainer.innerHTML = '';
            
            if (data.images && data.images.length > 0) {
                data.images.forEach((image, index) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'card mb-4';
                    
                    let cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header';
                    cardHeader.innerHTML = `<h5 class="mb-0">תמונה ${index + 1} (עמוד ${image.page_number})</h5>`;
                    
                    let cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    
                    let row = document.createElement('div');
                    row.className = 'row';
                    
                    let imageCol = document.createElement('div');
                    imageCol.className = 'col-md-6';
                    
                    if (image.image_data) {
                        let img = document.createElement('img');
                        img.src = `data:image/jpeg;base64,${image.image_data}`;
                        img.className = 'img-fluid';
                        img.alt = `תמונה ${index + 1}`;
                        imageCol.appendChild(img);
                    } else {
                        imageCol.innerHTML = '<p>תמונה לא זמינה</p>';
                    }
                    
                    let contentCol = document.createElement('div');
                    contentCol.className = 'col-md-6';
                    
                    let textHeader = document.createElement('h6');
                    textHeader.textContent = 'טקסט מהתמונה:';
                    contentCol.appendChild(textHeader);
                    
                    let textContent = document.createElement('p');
                    textContent.innerHTML = image.text ? image.text.replace(/\n/g, '<br>') : 'לא נמצא טקסט בתמונה';
                    contentCol.appendChild(textContent);
                    
                    // Add tables if available
                    if (image.tables && image.tables.length > 0) {
                        let tablesHeader = document.createElement('h6');
                        tablesHeader.textContent = 'טבלאות מהתמונה:';
                        contentCol.appendChild(tablesHeader);
                        
                        image.tables.forEach(table => {
                            let tableDiv = document.createElement('div');
                            tableDiv.className = 'table-responsive mb-3';
                            
                            let tableEl = document.createElement('table');
                            tableEl.className = 'table table-bordered';
                            
                            // Add headers
                            if (table.headers && table.headers.length > 0) {
                                let thead = document.createElement('thead');
                                let headerRow = document.createElement('tr');
                                
                                table.headers.forEach(header => {
                                    let th = document.createElement('th');
                                    th.textContent = header;
                                    headerRow.appendChild(th);
                                });
                                
                                thead.appendChild(headerRow);
                                tableEl.appendChild(thead);
                            }
                            
                            // Add data rows
                            if (table.data && table.data.length > 0) {
                                let tbody = document.createElement('tbody');
                                
                                table.data.forEach(row => {
                                    let tr = document.createElement('tr');
                                    
                                    row.forEach(cell => {
                                        let td = document.createElement('td');
                                        td.textContent = cell;
                                        tr.appendChild(td);
                                    });
                                    
                                    tbody.appendChild(tr);
                                });
                                
                                tableEl.appendChild(tbody);
                            }
                            
                            tableDiv.appendChild(tableEl);
                            contentCol.appendChild(tableDiv);
                        });
                    }
                    
                    row.appendChild(imageCol);
                    row.appendChild(contentCol);
                    
                    cardBody.appendChild(row);
                    
                    imageCard.appendChild(cardHeader);
                    imageCard.appendChild(cardBody);
                    
                    imagesContainer.appendChild(imageCard);
                });
            } else {
                imagesContainer.innerHTML = '<p>לא נמצאו תמונות במסמך</p>';
            }
        }
    </script>
</body>
</html> 